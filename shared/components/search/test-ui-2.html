<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klef Agency - B√∫squeda</title>
    <script src="./search-system.js" defer></script>
    <style>
        :root {
            --k-blue: #0066cc;
            --k-purple: #6e6eff;
            --k-orange: #e68600;
            --k-white: #ffffff;
            --k-light-gray: #f5f5f7;
            --k-black: #1d1d1f;
            --k-gray: #86868b;
            --k-border: #d2d2d7;

            --gradient-blue-a: linear-gradient(135deg, #97cbff 0%, #2787f6 100%);
        }

        * {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: var(--k-light-gray);
        }

        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .search-overlay.active {
            opacity: 1;
            pointer-events: all;
            background: rgba(0, 0, 0, 0.48);
            backdrop-filter: blur(20px);
        }

        .search-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: var(--k-white);
            transform: translateY(-100%);
            transition: transform 0.5s cubic-bezier(0.28, 0.11, 0.32, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .search-overlay.active .search-panel {
            transform: translateY(0);
        }

        .search-content {
            max-width: 980px;
            margin: 0 auto;
            padding: 60px 40px 80px;
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 16px;
            padding-bottom: 24px;
            border-bottom: 2px solid var(--k-border);
            margin-bottom: 32px;
        }

        .search-icon {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .search-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--k-gray);
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 28px;
            color: var(--k-black);
            background: transparent;
        }

        .search-input::placeholder {
            color: #6e6e73;
        }

        .close-search {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .search-overlay.active .close-search {
            opacity: 1;
            transition-delay: 0.3s;
        }

        .close-search:hover {
            background: rgba(0, 0, 0, 0.12);
        }

        .close-search svg {
            width: 16px;
            height: 16px;
            stroke: var(--k-black);
        }

        /* QUICK SUGGESTIONS */
        .quick-suggestions {
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s cubic-bezier(0.28, 0.11, 0.32, 1);
        }

        .search-overlay.active .quick-suggestions {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.2s;
        }

        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-top: 16px;
        }

        .suggestion-section {
            content: '';
        }

        .suggestion-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--k-gray);
            margin-bottom: 12px;
        }

        .suggestion-list {
            list-style: none;
        }

        .suggestion-list li {
            margin-bottom: 8px;
            border-bottom: 1px solid #d2d2d7;
        }

        .suggestion-list a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 18px 0;
            text-decoration: none;
            color: var(--k-black);
            font-size: 17px;
            transition: all 0.2s ease;
            flex-direction: row-reverse;
            justify-content: space-between;
            width: -webkit-fill-available;
        }



        .suggestion-list a:hover {
            color: var(--k-blue);
            background-image: linear-gradient(90deg, transparent, #e5e5e5);
        }

        .suggestion-list svg {
            width: 14px;
            height: 14px;
            opacity: 0.5;
            padding-right: 10px;
        }

        /* SEARCH RESULTS */
        .search-results {
            margin-top: 40px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 12px;

        }

        .results-header h4 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .results-count {
            font-size: 14px;
            color: var(--k-gray);
        }

        .results-count strong {
            color: var(--k-black);
            font-weight: 600;
        }

        .result-group {
            margin-bottom: 0;
        }

        .result-group-header {
            display: none;
        }

        .result-items {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;

        }

        .result-item {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            height: fit-content;
        }

        .result-item:hover {
            border-color: var(--k-blue);
            box-shadow: 0 12px 40px rgba(0, 102, 204, 0.12);
            transform: translateY(-8px);
        }

        .result-item a {
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .result-image {
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .result-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /*
        .result-image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f5f7 0%, #e8e8ed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }*/

        .result-image-placeholder {
            display: none;
        }

        .result-image-placeholder svg {
            width: 80px;
            height: 80px;
            opacity: 0.15;
        }

        .result-type-icon {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .result-type-icon svg {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .result-type-icon.blog svg {
            stroke: #ff6b6b;
        }

        .result-type-icon.page svg {
            stroke: var(--k-blue);
        }

        .result-type-icon.portfolio svg {
            stroke: var(--k-purple);
        }

        .result-type-icon.sin-categoria svg {
            stroke: var(--k-gray);
        }

        .result-content {
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .result-type-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .result-type-label.blog {
            color: #ff6b6b;
        }

        .result-type-label.page {
            color: var(--k-blue);
        }

        .result-type-label.portfolio {
            color: var(--k-orange);
        }

        .result-type-label.sin-categoria {
            color: var(--k-gray);
        }

        .result-title {
            font-size: 19px;
            font-weight: 600;
            color: var(--k-black);
            margin-bottom: 12px;
            line-height: 1.3;
        }

        .result-excerpt {
            font-size: 14px;
            color: var(--k-gray);
            line-height: 1.6;
            margin-bottom: 0;
            flex: 1;
            display: none;
        }

        .result-meta {
            display: none;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
        }

        .no-results-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            opacity: 0.3;
        }

        .no-results-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--k-black);
            margin-bottom: 12px;
        }

        .no-results-text {
            font-size: 15px;
            color: var(--k-gray);
        }

        .result-image:has(.result-image-placeholder) {
            height: 70px !important;
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--k-gray);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 16px;
            border: 3px solid var(--k-light-gray);
            border-top-color: var(--k-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .search-content {
                padding: 40px 20px 60px;
            }

            .search-input {
                font-size: 22px;
            }

            .suggestions-grid {
                grid-template-columns: 1fr;
            }

            .result-title {
                font-size: 15px;
            }
        }

        /* DEMO BUTTON */
        .demo-button {
            position: fixed;
            bottom: 40px;
            right: 40px;
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--k-blue), var(--k-purple));
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 102, 204, 0.3);
            transition: all 0.2s ease;
            z-index: 9999;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 102, 204, 0.4);
        }

        .result-image-placeholder+.result-type-icon {
            box-shadow: none;
        }

        .result-type-icon.page {
            background-color: #dbebfb;
            color: #0066cc;
        }

        .result-type-icon.blog {
            background-color: #fedddd;
            color: #e22626;
        }

        .result-type-icon.portfolio {
            color: #e68600;
            background-color: #fff4e5;
        }
    </style>
</head>

<body>
    <!-- Demo Button -->
    <button class="demo-button" onclick="openSearch()">
        üîç Abrir B√∫squeda
    </button>

    <!-- Search Overlay -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-panel">
            <button class="close-search" onclick="closeSearch()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <div class="search-content">
                <div class="search-input-wrapper">
                    <div class="search-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" class="search-input" placeholder="Buscar en klef.agency" id="searchInput"
                        autocomplete="off" spellcheck="false">
                </div>

                <div class="quick-suggestions" id="quickSuggestions">
                    <div class="suggestions-grid">
                        <div class="suggestion-section">
                            <div class="suggestion-title">Sugerencias</div>
                            <ul class="suggestion-list">
                                <li><a href="#" class="suggestion-link" data-search-term="portfolio">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Portfolio
                                    </a></li>
                                <li><a href="#" class="suggestion-link" data-search-term="servicios">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Servicios
                                    </a></li>
                                <li><a href="#" class="suggestion-link" data-search-term="contacto">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                        Contacto
                                    </a></li>
                            </ul>
                        </div>
                        <div class="suggestion-section">
                            <div class="suggestion-title">B√∫squedas recientes</div>
                            <ul class="suggestion-list" id="recentSearches">
                                <!-- Se llenar√° din√°micamente -->
                            </ul>
                        </div>
                    </div>
                </div>


                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <!-- SVG Icons (hidden) -->
    <svg style="display: none;">
        <symbol id="icon-page" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
            <polyline points="14 2 14 8 20 8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="icon-post" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
        <symbol id="icon-portfolio" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="13.5" cy="6.5" r=".5" stroke-width="2" />
            <circle cx="17.5" cy="10.5" r=".5" stroke-width="2" />
            <circle cx="8.5" cy="7.5" r=".5" stroke-width="2" />
            <circle cx="6.5" cy="12.5" r=".5" stroke-width="2" />
            <path
                d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </symbol>
    </svg>

    <script>
        // ============================================================================
        // CONFIGURATION LAYER
        // ============================================================================

        const CONFIG = {
            GRAPHQL_ENDPOINT: "https://klef.newfacecards.com/graphql",
            MIN_SEARCH_LENGTH: 2,
            DEBOUNCE_DELAY: 300,
            MAX_RECENT_SEARCHES: 5,
            RECENT_SEARCHES_DISPLAY: 3,
            STORAGE_KEY: 'recentSearches'
        };

        const CONTENT_TYPES = {
            PAGES: 'pages',
            POSTS: 'posts'
        };

        const TYPE_CONFIG = {
            [CONTENT_TYPES.PAGES]: {
                label: 'Page',
                icon: 'icon-page',
                class: 'page'
            },
            [CONTENT_TYPES.POSTS]: {
                label: 'Blog Post',
                icon: 'icon-post',
                class: 'blog'
            }
        };

        const IMAGE_CONFIG = {
            DEFAULT_HEIGHT: '200px',
            ALT_FALLBACK: 'Imagen'
        };

        const UI_MESSAGES = {
            NO_RESULTS_TITLE: 'No se encontraron resultados',
            NO_RESULTS_TEXT: 'Intenta con otros t√©rminos de b√∫squeda',
            NO_RECENT_SEARCHES: 'Sin b√∫squedas recientes',
            LOADING: 'Buscando...',
            ERROR: 'Error',
            RESULTS_FOR: 'Resultados para'
        };


        // ============================================================================
        // STATE LAYER
        // ============================================================================

        const State = {
            searchTimeout: null,
            recentSearches: [],

            init() {
                this.loadRecentSearches();
            },

            loadRecentSearches() {
                try {
                    const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
                    this.recentSearches = stored ? JSON.parse(stored) : [];
                } catch (error) {
                    Logger.error('Error loading recent searches', error);
                    this.recentSearches = [];
                }
            },

            saveRecentSearch(term) {
                this.recentSearches = [
                    term,
                    ...this.recentSearches.filter(t => t !== term)
                ].slice(0, CONFIG.MAX_RECENT_SEARCHES);

                try {
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(this.recentSearches));
                } catch (error) {
                    Logger.error('Error saving recent search', error);
                }
            },

            getRecentSearches(limit = CONFIG.RECENT_SEARCHES_DISPLAY) {
                return this.recentSearches.slice(0, limit);
            },

            setSearchTimeout(callback, delay) {
                this.clearSearchTimeout();
                this.searchTimeout = setTimeout(callback, delay);
            },

            clearSearchTimeout() {
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = null;
                }
            }
        };


        // ============================================================================
        // LOGGER UTILITY
        // ============================================================================

        const Logger = {
            query(query) {
                //console.log('GraphQL Search Query:', query);
            },

            response(searchTerm, data) {
                //console.log(`GraphQL Response for "${searchTerm}":`, data);
            },

            error(message, error) {
                console.error(`${message}:`, error);
            }
        };


        // ============================================================================
        // DOM REFERENCES
        // ============================================================================

        const DOM = {
            searchOverlay: null,
            searchInput: null,
            resultsContainer: null,
            quickSuggestions: null,
            recentSearches: null,

            init() {
                this.searchOverlay = document.getElementById('searchOverlay');
                this.searchInput = document.getElementById('searchInput');
                this.resultsContainer = document.getElementById('resultsContainer');
                this.quickSuggestions = document.getElementById('quickSuggestions');
                this.recentSearches = document.getElementById('recentSearches');
            }
        };


        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        const Utils = {
            stripHtml(html) {
                const tmp = document.createElement('div');
                tmp.innerHTML = html;
                return tmp.textContent || tmp.innerText || '';
            },

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-MX', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };


        // ============================================================================
        // GRAPHQL SERVICE
        // ============================================================================

        const GraphQLService = {
            async search(searchTerm) {
                const query = this.buildSearchQuery();

                Logger.query(query);

                try {
                    const response = await fetch(CONFIG.GRAPHQL_ENDPOINT, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            query,
                            variables: { searchTerm }
                        })
                    });

                    const json = await response.json();

                    Logger.response(searchTerm, json);

                    if (json.errors) {
                        throw new Error(json.errors[0].message);
                    }

                    return json.data;
                } catch (error) {
                    Logger.error('GraphQL Error', error);
                    throw error;
                }
            },

            buildSearchQuery() {
                return `
            query FlexibleSearch($searchTerm: String!) {
                pages(first: 20, where: { search: $searchTerm }) {
                    nodes {
                        id
                        title
                        slug
                        uri
                        date
                        content(format: RENDERED)
                        featuredImage {
                            node {
                                sourceUrl(size: MEDIUM)
                                altText
                            }
                        }
                    }
                }
                posts(first: 20, where: { search: $searchTerm }) {
                    nodes {
                        id
                        title
                        slug
                        uri
                        excerpt
                        date
                        featuredImage {
                            node {
                                sourceUrl(size: MEDIUM)
                                altText
                            }
                        }
                        categories {
                            nodes {
                                name
                            }
                        }
                    }
                }
            }
        `;
            }
        };


        // ============================================================================
        // DATA MAPPER
        // ============================================================================

        const DataMapper = {
            mapSearchResults(data) {
                const allResults = [];
                let totalResults = 0;

                Object.entries(data).forEach(([type, { nodes }]) => {
                    nodes.forEach(node => {
                        allResults.push({
                            ...node,
                            contentType: type,
                            config: TYPE_CONFIG[type]
                        });
                    });
                    totalResults += nodes.length;
                });

                return { allResults, totalResults };
            }
        };


        // ============================================================================
        // TEMPLATE BUILDER
        // ============================================================================

        const Templates = {
            recentSearchItem(term) {
                const escapedTerm = Utils.escapeHtml(term);
                return `
            <li>
                <a href="#" class="recent-search-link" data-search-term="${escapedTerm}" onclick="//console.log('click')">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ${escapedTerm}
                </a>
            </li>
        `;
            },

            noRecentSearches() {
                return `
            <li style="color: #86868b; font-size: 13px;">
                ${UI_MESSAGES.NO_RECENT_SEARCHES}
            </li>
        `;
            },

            loading() {
                return `
            <div class="loading">
                <div class="loading-spinner"></div>
                <div>${UI_MESSAGES.LOADING}</div>
            </div>
        `;
            },

            error(message) {
                return `
            <div class="no-results">
                <div class="no-results-title">${UI_MESSAGES.ERROR}</div>
                <div class="no-results-text">${Utils.escapeHtml(message)}</div>
            </div>
        `;
            },

            noResults() {
                return `
            <div class="no-results">
                <svg class="no-results-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <div class="no-results-title">${UI_MESSAGES.NO_RESULTS_TITLE}</div>
                <div class="no-results-text">${UI_MESSAGES.NO_RESULTS_TEXT}</div>
            </div>
        `;
            },

            resultsHeader(searchTerm, totalResults) {
                const plural = totalResults !== 1 ? 's' : '';
                return `
            <div class="results-header">
                <h4>${UI_MESSAGES.RESULTS_FOR} "${Utils.escapeHtml(searchTerm)}"</h4>
                <p>${totalResults} coincidencia${plural}</p>
            </div>
        `;
            },

            resultItem(node) {
                const config = node.config;
                const featuredImage = node.featuredImage?.node?.sourceUrl;
                const imageAlt = node.featuredImage?.node?.altText || node.title || IMAGE_CONFIG.ALT_FALLBACK;
                const imageHeight = IMAGE_CONFIG.DEFAULT_HEIGHT;

                const imageContent = featuredImage
                    ? `<img src="${featuredImage}" alt="${Utils.escapeHtml(imageAlt)}" loading="lazy">`
                    : `<div class="result-image-placeholder" style="height: 100%;">
                    <svg>
                        <use href="#${config.icon}"></use>
                    </svg>
                </div>`;

                return `
            <li class="result-item">
                <a href="${node.uri}">
                    <div class="result-image" style="height: ${imageHeight};">
                        ${imageContent}
                        <div class="result-type-icon ${config.class}">
                            <svg>
                                <use href="#${config.icon}"></use>
                            </svg>
                        </div>
                    </div>
                    <div class="result-content">
                        <div class="result-type-label ${config.class}">${config.label}</div>
                        <div class="result-title">${Utils.escapeHtml(node.title)}</div>
                    </div>
                </a>
            </li>
        `;
            },

            results(allResults) {
                return `
            <div class="result-group">
                <ul class="result-items">
                    ${allResults.map(node => this.resultItem(node)).join('')}
                </ul>
            </div>
        `;
            }
        };


        // ============================================================================
        // UI CONTROLLER
        // ============================================================================

        const UIController = {
            openSearch() {
                DOM.searchOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                setTimeout(() => DOM.searchInput.focus(), 400);
                this.updateRecentSearches();
            },

            closeSearch() {
                DOM.searchOverlay.classList.remove('active');
                document.body.style.overflow = '';
                DOM.searchInput.value = '';
                DOM.resultsContainer.innerHTML = '';
                DOM.quickSuggestions.style.display = 'block';
            },

            updateRecentSearches() {
                const searches = State.getRecentSearches();

                if (searches.length === 0) {
                    DOM.recentSearches.innerHTML = Templates.noRecentSearches();
                } else {
                    DOM.recentSearches.innerHTML = searches
                        .map(term => Templates.recentSearchItem(term))
                        .join('');
                }
            },

            showLoading() {
                DOM.quickSuggestions.style.display = 'none';
                DOM.resultsContainer.innerHTML = Templates.loading();
            },

            showError(error) {
                DOM.resultsContainer.innerHTML = Templates.error(error.message);
            },

            showResults(data, searchTerm) {
                const { allResults, totalResults } = DataMapper.mapSearchResults(data);

                let html = '';

                if (totalResults === 0) {
                    html = Templates.noResults();
                } else {
                    html = Templates.resultsHeader(searchTerm, totalResults) +
                        Templates.results(allResults);
                }

                DOM.resultsContainer.innerHTML = html;
            },

            clearResults() {
                DOM.resultsContainer.innerHTML = '';
                DOM.quickSuggestions.style.display = 'block';
            }
        };


        // ============================================================================
        // SEARCH CONTROLLER
        // ============================================================================

        const SearchController = {
            async performSearch(searchTerm) {
                const trimmedTerm = searchTerm.trim();

                Logger.query(`Performing search for: "${trimmedTerm}"`);

                if (trimmedTerm.length < CONFIG.MIN_SEARCH_LENGTH) {
                    UIController.clearResults();
                    return;
                }

                UIController.showLoading();

                try {
                    const data = await GraphQLService.search(trimmedTerm);
                    UIController.showResults(data, trimmedTerm);
                    State.saveRecentSearch(trimmedTerm);
                    UIController.updateRecentSearches();
                } catch (error) {
                    UIController.showError(error);
                }
            },

            searchFor(term) {
                //console.log('SearchController.searchFor called with term:', term);
                DOM.searchInput.value = term;
                this.performSearch(term);
            }
        };


        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================

        const EventHandlers = {
            onSearchInput(event) {
                State.clearSearchTimeout();
                const term = event.target.value.trim();

                if (term.length >= CONFIG.MIN_SEARCH_LENGTH) {
                    State.setSearchTimeout(
                        () => SearchController.performSearch(term),
                        CONFIG.DEBOUNCE_DELAY
                    );
                } else {
                    UIController.clearResults();
                }
            },

            onOverlayClick(event) {
                if (event.target === DOM.searchOverlay) {
                    UIController.closeSearch();
                }
            },

            onSuggestionClick(event) {
                const link = event.target.closest('a[data-search-term]');
                if (link) {
                    event.preventDefault();
                    const term = link.getAttribute('data-search-term');
                    //console.log('Suggestion clicked:', term);
                    SearchController.searchFor(term);
                }
            },

            onKeyDown(event) {
                // ESC para cerrar
                if (event.key === 'Escape' && DOM.searchOverlay.classList.contains('active')) {
                    UIController.closeSearch();
                }

                // Ctrl+K o Cmd+K para abrir
                if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                    event.preventDefault();
                    UIController.openSearch();
                }
            }
        };

        // ============================================================================
        // EVENT LISTENERS SETUP
        // ============================================================================

        const EventListeners = {
            init() {
                //console.log('üîß Inicializando Event Listeners...');
                //console.log('DOM.searchInput:', DOM.searchInput);
                //console.log('DOM.searchOverlay:', DOM.searchOverlay);
                //console.log('DOM.quickSuggestions:', DOM.quickSuggestions);

                // Input de b√∫squeda
                DOM.searchInput.addEventListener('input', EventHandlers.onSearchInput);
                //console.log('‚úÖ Listener de input agregado');

                // Click en overlay
                DOM.searchOverlay.addEventListener('click', EventHandlers.onOverlayClick);
                //console.log('‚úÖ Listener de overlay agregado');

                // Teclado
                document.addEventListener('keydown', EventHandlers.onKeyDown);
                //console.log('‚úÖ Listener de teclado agregado');

                // Delegaci√≥n de eventos para TODAS las sugerencias (est√°ticas y din√°micas)
                if (DOM.quickSuggestions) {
                    DOM.quickSuggestions.addEventListener('click', EventHandlers.onSuggestionClick);
                    //console.log('‚úÖ Listener de sugerencias agregado a:', DOM.quickSuggestions);
                } else {
                    console.error('‚ùå DOM.quickSuggestions es null!');
                }
            }
        };


        // ============================================================================
        // APP INITIALIZATION
        // ============================================================================

        const App = {
            init() {
                DOM.init();
                State.init();
                EventListeners.init();
                UIController.updateRecentSearches();
            }
        };

        // Funciones globales para mantener compatibilidad con HTML
        function openSearch() {
            UIController.openSearch();
        }

        function closeSearch() {
            UIController.closeSearch();
        }

        function searchFor(term) {
            SearchController.searchFor(term);
        }

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => App.init());
        } else {
            App.init();
        }
    </script>
</body>

</html>